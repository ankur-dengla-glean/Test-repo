name: trigger_workflow_from_comment
on:
  issue_comment:
    types:
      - created

jobs:
  trigger_workflow:
    permissions:
      actions: write
      checks: write
      contents: write
      pull-requests: read
    if: github.event.issue.pull_request && github.event.comment.body == '\trigger-pr-check'
    runs-on: ubuntu-latest

    steps:
      - name: Get PR Details
        id: get-pr-details
        run: | 
          PR_HEAD_BRANCH=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}" \
            |jq -r .head.ref)

          echo "pr_head=${PR_HEAD_BRANCH}" >> $GITHUB_OUTPUT

      - name: Trigger PR Check Workflow
        run: |
          if [[ ${{ github.event_name }} == 'issue_comment' && ${{ github.event.issue.pull_request }} ]]; then
            # Check if the comment contains a specific trigger phrase
            if [[ $(echo "${{ github.event.comment.body }}" | grep -E '\trigger-pr-check') ]]; then
              echo "Triggering the PR Check workflow..."
              # Trigger the PR Check workflow using repository_dispatch event
              curl -L \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                https://api.github.com/repos/${{ github.repository }}/actions/workflows/pr_check.yml/dispatches \
                -d '{"ref":"${{ steps.get-pr-details.outputs.pr_head }}"}'
            else
              echo "Comment does not contain the trigger phrase. Skipping the workflow trigger."
            fi
          else
            echo "Not a pull request comment. Skipping the workflow trigger."
          fi
